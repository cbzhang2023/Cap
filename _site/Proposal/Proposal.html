<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Proposal â€“ Cap</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Cap</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-proposal" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Proposal</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-proposal">    
        <li>
    <a class="dropdown-item" href="../Proposal/Proposal.html">
 <span class="dropdown-text">Proposal</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-app" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">APP</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-app">    
        <li>
    <a class="dropdown-item" href="../In-class_EX/In-class_EX01/In-class EX01.html">
 <span class="dropdown-text">APP</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-intro" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Intro</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-intro">    
        <li>
    <a class="dropdown-item" href="../Take-home_Ex/Take-home_Ex01/Take-home Exercise 1.html">
 <span class="dropdown-text">Intro</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.qmd"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <span class="nav-link">
<span class="menu-text">about.qmd</span>
    </span>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#proposal-predicting-rental-prices-with-business-trends" id="toc-proposal-predicting-rental-prices-with-business-trends" class="nav-link active" data-scroll-target="#proposal-predicting-rental-prices-with-business-trends">Proposal: Predicting Rental Prices with Business Trends</a></li>
  <li><a href="#project-overview" id="toc-project-overview" class="nav-link" data-scroll-target="#project-overview">1. Project Overview</a></li>
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">2. Objectives</a></li>
  <li><a href="#data-overview" id="toc-data-overview" class="nav-link" data-scroll-target="#data-overview">3. Data Overview</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">4. Methodology</a>
  <ul class="collapse">
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing">4.1 Data Preprocessing</a></li>
  <li><a href="#geocoding-using-geocode.xyz-api" id="toc-geocoding-using-geocode.xyz-api" class="nav-link" data-scroll-target="#geocoding-using-geocode.xyz-api"><strong>4.2 Geocoding Using Geocode.xyz API</strong></a></li>
  <li><a href="#geographical-accessibility-modeling" id="toc-geographical-accessibility-modeling" class="nav-link" data-scroll-target="#geographical-accessibility-modeling">4.3 Geographical Accessibility Modeling</a></li>
  <li><a href="#rental-price-modeling" id="toc-rental-price-modeling" class="nav-link" data-scroll-target="#rental-price-modeling">4.4 Rental Price Modeling</a></li>
  </ul></li>
  <li><a href="#tools-and-packages" id="toc-tools-and-packages" class="nav-link" data-scroll-target="#tools-and-packages">5. Tools and Packages</a>
  <ul class="collapse">
  <li><a href="#r-packages" id="toc-r-packages" class="nav-link" data-scroll-target="#r-packages">5.1 R Packages</a></li>
  <li><a href="#additional-tools" id="toc-additional-tools" class="nav-link" data-scroll-target="#additional-tools">5.2 Additional Tools</a></li>
  </ul></li>
  <li><a href="#expected-deliverables" id="toc-expected-deliverables" class="nav-link" data-scroll-target="#expected-deliverables">6. Expected Deliverables</a>
  <ul class="collapse">
  <li><a href="#spatial-analysis-outputs" id="toc-spatial-analysis-outputs" class="nav-link" data-scroll-target="#spatial-analysis-outputs">6.1 Spatial Analysis Outputs</a></li>
  <li><a href="#predictive-model" id="toc-predictive-model" class="nav-link" data-scroll-target="#predictive-model">6.2 Predictive Model</a></li>
  <li><a href="#interactive-dashboard" id="toc-interactive-dashboard" class="nav-link" data-scroll-target="#interactive-dashboard">6.3 Interactive Dashboard</a></li>
  <li><a href="#comprehensive-report" id="toc-comprehensive-report" class="nav-link" data-scroll-target="#comprehensive-report">6.4 Comprehensive Report</a></li>
  </ul></li>
  <li><a href="#challenges-and-mitigation" id="toc-challenges-and-mitigation" class="nav-link" data-scroll-target="#challenges-and-mitigation">7. Challenges and Mitigation</a>
  <ul class="collapse">
  <li><a href="#geocoding-accuracy" id="toc-geocoding-accuracy" class="nav-link" data-scroll-target="#geocoding-accuracy">7.1 Geocoding Accuracy</a></li>
  <li><a href="#handling-large-datasets" id="toc-handling-large-datasets" class="nav-link" data-scroll-target="#handling-large-datasets">7.2 Handling Large Datasets</a></li>
  <li><a href="#model-generalization" id="toc-model-generalization" class="nav-link" data-scroll-target="#model-generalization">7.3 Model Generalization</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">8. Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Proposal</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="proposal-predicting-rental-prices-with-business-trends" class="level2">
<h2 class="anchored" data-anchor-id="proposal-predicting-rental-prices-with-business-trends">Proposal: Predicting Rental Prices with Business Trends</h2>
</section>
<section id="project-overview" class="level2">
<h2 class="anchored" data-anchor-id="project-overview">1. Project Overview</h2>
<p>Rental prices in urban areas are influenced by various factors, including business activities, geographical accessibility, and economic growth patterns. This project aims to build a comprehensive understanding of how business trends affect rental markets by leveraging postal codes for spatial mapping, conducting spatial analyses, and using machine learning to predict future rental price trends. The project will culminate in an R Shiny dashboard and an R Quarto report documenting the entire process and insights.</p>
</section>
<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">2. Objectives</h2>
<p><strong>Understand Business Trends:</strong></p>
<p>Analyze temporal and spatial patterns of business registrations and closures using postal codes for accurate geolocation.</p>
<p>Identify business hotspots and trends over time.</p>
<p><strong>Assess Geographical Accessibility:</strong></p>
<p>Examine how accessibility to business hubs affects rental prices.</p>
<p>Model the impact of spatial factors such as proximity and density on rental prices.</p>
<p><strong>Predict Future Rental Prices:</strong></p>
<p>Develop a predictive model that incorporates business trends, geographical accessibility, and property characteristics.</p>
</section>
<section id="data-overview" class="level2">
<h2 class="anchored" data-anchor-id="data-overview">3. Data Overview</h2>
<p><strong>Dataset 1</strong>: EntitiesRegisteredwithACRA.csv</p>
<p>Contains information on business registrations and closures, including postal codes for geospatial identification.</p>
<p><strong>Key Columns:</strong></p>
<p>Business ID, Registration Date, Closure Date</p>
<p>Business Type, Sector</p>
<p>Location (postal code or address)</p>
<p><strong>Dataset 2</strong>: RentingOutofFlats2024CSV.csv</p>
<p>Includes residential rental price data.</p>
<p><strong>Key Columns:</strong></p>
<p>Rental Price, Lease Type, Property Type</p>
<p>Location (postal code or address), Lease Duration</p>
<p>Start Date, End Date</p>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">4. Methodology</h2>
<section id="data-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="data-preprocessing">4.1 Data Preprocessing</h3>
<p><strong>Cleaning and Standardization:</strong></p>
<p>Remove duplicates and handle missing values.</p>
<p>Standardize date formats and ensure consistent variable naming conventions.</p>
<p><strong>Geocoding Using Postal Codes:</strong></p>
<p>Extract postal codes from Dataset 1 (EntitiesRegisteredwithACRA.csv) and Dataset 2 (RentingOutofFlats2024CSV.csv).</p>
<p><strong>Use postal codes to determine spatial coordinates (latitude and longitude):</strong></p>
<p>Use APIs like Google Maps, OneMap (Singapore), or OpenStreetMap.</p>
<p>Cross-validate results with an authoritative postal code database to ensure accuracy.</p>
<p>Generate a spatial dataset with precise geolocations for businesses and rental properties.</p>
<p><strong>Spatial Integration:</strong></p>
<p>Integrate datasets by matching geographical regions or proximity.</p>
<p>Use postal code-based boundaries for initial integration and fine-tune with exact coordinates.</p>
</section>
<section id="geocoding-using-geocode.xyz-api" class="level3">
<h3 class="anchored" data-anchor-id="geocoding-using-geocode.xyz-api"><strong>4.2 Geocoding Using Geocode.xyz API</strong></h3>
<section id="purpose" class="level4">
<h4 class="anchored" data-anchor-id="purpose"><strong>Purpose</strong></h4>
<p>To transform detailed address information into precise spatial coordinates (latitude and longitude) for each rental property.</p>
</section>
<section id="steps" class="level4">
<h4 class="anchored" data-anchor-id="steps"><strong>Steps</strong></h4>
<ol type="1">
<li><p><strong>Prepare Full Address</strong></p>
<p>Construct a <code>full_address</code> field by concatenating key address components:</p></li>
<li><p><strong>Geocoding Process</strong></p>
<p>Use the <strong>Geocode.xyz API</strong> to convert the <code>full_address</code> into geographic coordinates:</p>
<p>Input: Full address string.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>reantal_unclean_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/RentingOutofFlats2024CSV.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(reantal_unclean_data, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 Ã— 6
  rent_approval_date town       block street_name      flat_type monthly_rent
  &lt;chr&gt;              &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt;            &lt;dbl&gt;
1 2021-01            ANG MO KIO 105   ANG MO KIO AVE 4 4-ROOM            2000
2 2021-01            ANG MO KIO 107   ANG MO KIO AVE 4 3-ROOM            1750
3 2021-01            ANG MO KIO 108   ANG MO KIO AVE 4 3-ROOM            1750
4 2021-01            ANG MO KIO 111   ANG MO KIO AVE 4 5-ROOM            2230
5 2021-01            ANG MO KIO 111   ANG MO KIO AVE 4 5-ROOM            2450</code></pre>
</div>
</div>
<p><img src="..\images/clipboard-3740434886.png" class="img-fluid"></p></li>
<li><p>Output: Latitude and longitude values returned by the API.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>reantal_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/merged_hdb_with_coordinates.csv"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(reantal_unclean_data, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 Ã— 6
  rent_approval_date town       block street_name      flat_type monthly_rent
  &lt;chr&gt;              &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt;            &lt;dbl&gt;
1 2021-01            ANG MO KIO 105   ANG MO KIO AVE 4 4-ROOM            2000
2 2021-01            ANG MO KIO 107   ANG MO KIO AVE 4 3-ROOM            1750
3 2021-01            ANG MO KIO 108   ANG MO KIO AVE 4 3-ROOM            1750
4 2021-01            ANG MO KIO 111   ANG MO KIO AVE 4 5-ROOM            2230
5 2021-01            ANG MO KIO 111   ANG MO KIO AVE 4 5-ROOM            2450</code></pre>
</div>
</div>
<p><img src="..\images/clipboard-25686400.png" class="img-fluid"></p></li>
<li><p><strong>API Configuration</strong></p>
<p>Geocode.xyz provides accurate geocoding for global locations, including Singapore. The API allows queries for full address strings and returns precise geographic coordinates along with additional metadata.</p></li>
<li><p><strong>Error Handling and Validation</strong></p>
<p>Monitor the API responses to handle:</p>
<p>Invalid or ambiguous address queries.</p>
<p>API rate limits by batching requests or incorporating pauses between queries.</p>
<p>Cross-validate geocoded coordinates using authoritative postal code boundaries to ensure accuracy.</p></li>
</ol>
</section>
</section>
<section id="geographical-accessibility-modeling" class="level3">
<h3 class="anchored" data-anchor-id="geographical-accessibility-modeling">4.3 Geographical Accessibility Modeling</h3>
<section id="travel-time-and-proximity-analysis" class="level4">
<h4 class="anchored" data-anchor-id="travel-time-and-proximity-analysis">4.3.1 Travel Time and Proximity Analysis</h4>
<section id="purpose-1" class="level5">
<h5 class="anchored" data-anchor-id="purpose-1">Purpose</h5>
<p>To compute the travel times between rental properties and business clusters, and to analyze their proximity to key infrastructure such as public transport stations, major roads, and business hubs. This analysis will provide essential features for later predictive modeling.</p>
</section>
<section id="methodology-1" class="level5">
<h5 class="anchored" data-anchor-id="methodology-1">Methodology</h5>
<p>We will perform <strong>network-based spatial analysis</strong> using tools such as:</p>
<ul>
<li><strong>OSRM (Open Source Routing Machine)</strong> for real-time routing and travel time calculation.</li>
<li><strong>gdistance</strong> package in R to compute the least-cost path based on road networks.</li>
</ul>
</section>
<section id="travel-time-calculation-using-osrm" class="level5">
<h5 class="anchored" data-anchor-id="travel-time-calculation-using-osrm">Travel Time Calculation Using OSRM</h5>
<p>OSRM is used to calculate travel times between rental properties and business hotspots based on the shortest paths over a road network.</p>
<p>Given a set of rental property locations ( P = {p_1, p_2, , p_n} ) and a set of business hotspots ( H = {h_1, h_2, , h_m} ), the travel time between a property ( p_i ) and a hotspot ( h_j ) is calculated as:</p>
<p><span class="math display">\[
T(p_i, h_j) = f(\text{distance}, \text{speed limit}, \text{road type})
\]</span></p>
<p>Where:<br>
- ( T(p_i, h_j) ) is the travel time from property ( p_i ) to hotspot ( h_j ).<br>
- ( ) is the road distance between the two points.<br>
- ( ) is the maximum speed allowed on each segment of the road network.<br>
- ( ) accounts for road hierarchies (e.g., highways, local streets).</p>
</section>
<section id="proximity-analysis" class="level5">
<h5 class="anchored" data-anchor-id="proximity-analysis">Proximity Analysis</h5>
<p>Proximity to key infrastructure will be computed using <strong>Euclidean distance</strong> and <strong>network distance</strong>.</p>
<p>The Euclidean distance between two points ( (x_1, y_1) ) and ( (x_2, y_2) ) is calculated as:</p>
<p><span class="math display">\[
d = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}
\]</span></p>
<p>However, since real-world travel happens along road networks, <strong>network distance</strong> will be used for a more realistic analysis. Network distance is computed by summing the lengths of road segments between two points.</p>
</section>
<section id="accessibility-to-public-transport-and-major-roads" class="level5">
<h5 class="anchored" data-anchor-id="accessibility-to-public-transport-and-major-roads">Accessibility to Public Transport and Major Roads</h5>
<p>We will calculate the proximity of rental properties to:</p>
<ul>
<li><strong>MRT (Mass Rapid Transit) stations</strong></li>
<li><strong>Bus stops</strong></li>
<li><strong>Major roads and expressways</strong></li>
</ul>
<p>Let ( p_i ) be a rental property, and ( t_j ) be the nearest transport station:</p>
<p><span class="math display">\[
D(p_i, t_j) = \min \{d(p_i, t_k) \mid t_k \in T\}
\]</span></p>
<p>Where:<br>
- ( D(p_i, t_j) ) is the shortest network distance from property ( p_i ) to the nearest transport station ( t_j ).<br>
- ( T ) is the set of all transport stations.</p>
</section>
</section>
<section id="accessibility-index-development" class="level4">
<h4 class="anchored" data-anchor-id="accessibility-index-development">4.3.2 Accessibility Index Development</h4>
<p>To develop an <strong>Accessibility Index</strong> that combines various accessibility metrics, including travel time, proximity to business hubs, and density of nearby businesses.</p>
<p>The <strong>Accessibility Index (AI)</strong> for a rental property ( p_i ) is calculated as:</p>
<p><span class="math display">\[
AI(p_i) = \alpha \cdot \frac{1}{T(p_i, h_j)} + \beta \cdot \frac{1}{D(p_i, t_j)} + \gamma \cdot B(p_i)
\]</span></p>
<p>Where:<br>
- ( T(p_i, h_j) ) is the travel time from property ( p_i ) to the nearest business hub ( h_j ).<br>
- ( D(p_i, t_j) ) is the network distance from property ( p_i ) to the nearest transport station ( t_j ).<br>
- ( B(p_i) ) is the density of businesses within a defined radius around ( p_i ).<br>
- ( ), ( ), and ( ) are weighting factors to balance the importance of each component.</p>
</section>
</section>
<section id="rental-price-modeling" class="level3">
<h3 class="anchored" data-anchor-id="rental-price-modeling">4.4 Rental Price Modeling</h3>
<section id="feature-engineering" class="level4">
<h4 class="anchored" data-anchor-id="feature-engineering">4.4.1 Feature Engineering</h4>
<section id="purpose-2" class="level5">
<h5 class="anchored" data-anchor-id="purpose-2">Purpose</h5>
<p>To create additional variables (features) that capture spatial, temporal, and property-related characteristics for use in predictive modeling.</p>
</section>
<section id="derived-features" class="level5">
<h5 class="anchored" data-anchor-id="derived-features">Derived Features</h5>
<ol type="1">
<li><strong>Spatial Features</strong>
<ul>
<li>Accessibility Index (computed in Section 4.3).<br>
</li>
<li>Proximity to business hubs, public transport, and major roads.<br>
</li>
<li>Density of nearby businesses.</li>
</ul></li>
<li><strong>Temporal Features</strong>
<ul>
<li>Yearly and monthly rental trends.<br>
</li>
<li>Seasonal variations (e.g., higher rents during certain months).</li>
</ul></li>
<li><strong>Property Features</strong>
<ul>
<li>Property type (e.g., 3-room, 4-room).<br>
</li>
<li>Lease type (e.g., short-term, long-term).<br>
</li>
<li>Lease duration.</li>
</ul></li>
</ol>
</section>
</section>
<section id="predictive-modeling" class="level4">
<h4 class="anchored" data-anchor-id="predictive-modeling">4.4.2 Predictive Modeling</h4>
<section id="purpose-3" class="level5">
<h5 class="anchored" data-anchor-id="purpose-3">Purpose</h5>
<p>To build machine learning models that predict rental prices based on the derived features.</p>
</section>
<section id="methodology-2" class="level5">
<h5 class="anchored" data-anchor-id="methodology-2">Methodology</h5>
<p>We will use the following machine learning algorithms:</p>
<ol type="1">
<li><strong>Random Forest (RF)</strong><br>
</li>
<li><strong>XGBoost (Extreme Gradient Boosting)</strong><br>
</li>
<li><strong>Gradient Boosting Machines (GBM)</strong></li>
</ol>
</section>
<section id="random-forest-model" class="level5">
<h5 class="anchored" data-anchor-id="random-forest-model">Random Forest Model</h5>
<p>Random Forest is an ensemble learning method that builds multiple decision trees and combines their outputs to improve prediction accuracy.</p>
<p>The predicted rental price ( ) is computed as:</p>
<p><span class="math display">\[
\hat{y} = \frac{1}{n} \sum_{i=1}^{n} f_i(x)
\]</span></p>
<p>Where:<br>
- ( n ) is the number of decision trees in the forest.<br>
- ( f_i(x) ) is the prediction from the ( i^{th} ) tree.</p>
</section>
<section id="evaluation-metrics" class="level5">
<h5 class="anchored" data-anchor-id="evaluation-metrics">Evaluation Metrics</h5>
<p>We will evaluate the models using the following metrics:</p>
<ol type="1">
<li><p><strong>Root Mean Square Error (RMSE)</strong><br>
Measures the average magnitude of errors.</p>
<p><span class="math display">\[
RMSE = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (\hat{y}_i - y_i)^2}
\]</span></p></li>
<li><p><strong>RÂ² (Coefficient of Determination)</strong><br>
Measures how well the model explains the variability of the target variable.</p>
<p><span class="math display">\[
R^2 = 1 - \frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{\sum_{i=1}^{n} (y_i - \bar{y})^2}
\]</span></p></li>
<li><p><strong>Mean Absolute Error (MAE)</strong><br>
Measures the average absolute error between predicted and actual values.</p>
<p><span class="math display">\[
MAE = \frac{1}{n} \sum_{i=1}^{n} |\hat{y}_i - y_i|
\]</span></p></li>
</ol>
</section>
</section>
<section id="model-interpretation-and-insights" class="level4">
<h4 class="anchored" data-anchor-id="model-interpretation-and-insights">4.4.3 Model Interpretation and Insights</h4>
<p>Once the models are trained and evaluated, feature importance analysis will be conducted to identify the most significant factors affecting rental prices. The insights derived from the models will inform stakeholders about key drivers of rental price fluctuations.</p>
</section>
<section id="prediction-and-visualization" class="level4">
<h4 class="anchored" data-anchor-id="prediction-and-visualization">4.4.4 Prediction and Visualization</h4>
<p><strong>Forecasting Future Rental Prices:</strong></p>
<p>Predict rental price changes by incorporating temporal patterns of business activity.</p>
<p>Identify high-growth areas for strategic urban planning.</p>
<p><strong>Interactive R Shiny Dashboard:</strong></p>
<p>Visualize:</p>
<p>Business trends over time and space.</p>
<p>Accessibility analysis and its correlation with rental prices.</p>
<p>Predicted rental price trends by region.</p>
<p><strong>R Quarto Report:</strong></p>
<p>Document all analysis steps, methods, and findings.</p>
<p>Include visualizations such as heatmaps, spatial plots, and trend charts.</p>
</section>
</section>
</section>
<section id="tools-and-packages" class="level2">
<h2 class="anchored" data-anchor-id="tools-and-packages">5. Tools and Packages</h2>
<p>This project will leverage a variety of R tools and packages to perform data cleaning, geocoding, spatial analysis, machine learning, and visualization. Below is a detailed breakdown of the packages used in each step of the analysis process.</p>
<section id="r-packages" class="level3">
<h3 class="anchored" data-anchor-id="r-packages">5.1 R Packages</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 26%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Category</strong></th>
<th><strong>Packages</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Data Cleaning</strong></td>
<td><code>dplyr</code>, <code>tidyr</code></td>
<td>For data wrangling, handling missing values, and reshaping data.</td>
</tr>
<tr class="even">
<td><strong>Geocoding</strong></td>
<td><code>ggmap</code>, <code>osmdata</code>, <code>tmaptools</code></td>
<td>For converting addresses into spatial coordinates (latitude and longitude).</td>
</tr>
<tr class="odd">
<td><strong>Spatial Analysis</strong></td>
<td><code>sf</code>, <code>spatstat</code>, <code>spdep</code>, <code>NKDE</code></td>
<td>For handling spatial data, performing spatial point pattern analysis, and spatial autocorrelation.</td>
</tr>
<tr class="even">
<td><strong>Accessibility Modeling</strong></td>
<td><code>osrm</code>, <code>gdistance</code></td>
<td>For calculating travel times and proximity measures using network-based spatial analysis.</td>
</tr>
<tr class="odd">
<td><strong>Machine Learning</strong></td>
<td><code>caret</code>, <code>randomForest</code>, <code>xgboost</code>, <code>glmnet</code></td>
<td>For building and tuning predictive models to forecast rental prices.</td>
</tr>
<tr class="even">
<td><strong>Visualization</strong></td>
<td><code>ggplot2</code>, <code>leaflet</code>, <code>shiny</code>, <code>tmap</code></td>
<td>For creating static and interactive visualizations, maps, and dashboards.</td>
</tr>
<tr class="odd">
<td><strong>Reporting</strong></td>
<td><code>quarto</code>, <code>knitr</code>, <code>rmarkdown</code></td>
<td>For generating reproducible reports and documentation.</td>
</tr>
</tbody>
</table>
</section>
<section id="additional-tools" class="level3">
<h3 class="anchored" data-anchor-id="additional-tools">5.2 Additional Tools</h3>
<ul>
<li><strong>Geocode.xyz API</strong>: Used for geocoding addresses to obtain precise latitude and longitude coordinates.</li>
</ul>
</section>
</section>
<section id="expected-deliverables" class="level2">
<h2 class="anchored" data-anchor-id="expected-deliverables">6. Expected Deliverables</h2>
<p>The project will produce multiple outputs, including spatial analysis results, a trained predictive model, an interactive dashboard, and a comprehensive report. Below is a detailed list of the expected deliverables.</p>
<section id="spatial-analysis-outputs" class="level3">
<h3 class="anchored" data-anchor-id="spatial-analysis-outputs">6.1 Spatial Analysis Outputs</h3>
<p>The project will produce a series of spatial analysis outputs, including:</p>
<ul>
<li><p><strong>Maps of Business Activity Hotspots</strong><br>
Identifying clusters of business activities using spatial point pattern analysis (e.g., KDE, spatial autocorrelation).</p></li>
<li><p><strong>Accessibility Analysis Layers</strong><br>
Maps showing travel times and proximity to business hubs, public transport, and major roads, providing insights into the geographical accessibility of rental properties.</p></li>
</ul>
</section>
<section id="predictive-model" class="level3">
<h3 class="anchored" data-anchor-id="predictive-model">6.2 Predictive Model</h3>
<p>The project will develop a <strong>trained machine learning model</strong> to predict rental prices based on spatial, temporal, and property-related features. The model will be evaluated using multiple metrics, including <strong>RMSE</strong>, <strong>RÂ²</strong>, and <strong>MAE</strong>, to ensure accuracy and robustness.</p>
<p><strong>Key Features of the Model:</strong></p>
<ul>
<li><strong>Inputs</strong>: Accessibility index, proximity to business hubs, lease type, property type, lease duration, and seasonal trends.</li>
<li><strong>Algorithms</strong>: Random Forest, XGBoost, and Gradient Boosting Machines (GBM).</li>
<li><strong>Outputs</strong>: Predicted rental prices with confidence intervals.</li>
</ul>
</section>
<section id="interactive-dashboard" class="level3">
<h3 class="anchored" data-anchor-id="interactive-dashboard">6.3 Interactive Dashboard</h3>
<p>An <strong>R Shiny dashboard</strong> will be developed to provide users with an interactive interface to explore rental trends, visualize accessibility, and predict rental prices based on user-defined parameters.</p>
<p><strong>Key Features of the Dashboard:</strong></p>
<ul>
<li><strong>Interactive Maps</strong>: Visualizing business activity hotspots, accessibility layers, and rental price predictions.</li>
<li><strong>Trend Analysis</strong>: Exploring rental trends over time (monthly, yearly).</li>
<li><strong>Prediction Tool</strong>: Allowing users to input property details and predict rental prices in real time.</li>
</ul>
</section>
<section id="comprehensive-report" class="level3">
<h3 class="anchored" data-anchor-id="comprehensive-report">6.4 Comprehensive Report</h3>
<p>A <strong>comprehensive R Quarto report</strong> will be produced, documenting the entire analysis process, key insights, and recommendations. The report will include:</p>
<ul>
<li><strong>Introduction and Objectives</strong><br>
</li>
<li><strong>Methodology</strong> (Data Cleaning, Geocoding, Spatial Analysis, Modeling)<br>
</li>
<li><strong>Results and Discussion</strong><br>
</li>
<li><strong>Recommendations for Policy and Business Decisions</strong></li>
</ul>
</section>
</section>
<section id="challenges-and-mitigation" class="level2">
<h2 class="anchored" data-anchor-id="challenges-and-mitigation">7. Challenges and Mitigation</h2>
<p>Several challenges are anticipated during the project. Below is a breakdown of these challenges and the corresponding mitigation strategies.</p>
<section id="geocoding-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="geocoding-accuracy">7.1 Geocoding Accuracy</h3>
<p><strong>Challenge:</strong><br>
Geocoding accuracy is critical for spatial analysis. Inaccurate or incomplete geocoding can impact the reliability of the results.</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Use <strong>verified postal code databases</strong> to cross-check the accuracy of geocoded coordinates.</li>
<li>Leverage <strong>multiple geocoding APIs</strong> for cross-validation.</li>
<li>Implement <strong>error-handling mechanisms</strong> to detect and correct incorrect geocoded locations.</li>
</ul>
</section>
<section id="handling-large-datasets" class="level3">
<h3 class="anchored" data-anchor-id="handling-large-datasets">7.2 Handling Large Datasets</h3>
<p><strong>Challenge:</strong><br>
The datasets involved may be large, especially when working with spatial data, which can lead to performance issues.</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Use <strong>optimized data structures</strong> in R, such as <code>sf</code> for spatial data and <code>data.table</code> for large datasets.</li>
<li>Utilize <strong>parallel processing</strong> to speed up spatial and machine learning computations.</li>
<li>Consider using <strong>PostgreSQL/PostGIS</strong> for efficient storage and querying of spatial data.</li>
</ul>
</section>
<section id="model-generalization" class="level3">
<h3 class="anchored" data-anchor-id="model-generalization">7.3 Model Generalization</h3>
<p><strong>Challenge:</strong><br>
Ensuring that the predictive model performs well across different regions and timeframes is crucial for reliable rental price predictions.</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Perform <strong>thorough model validation</strong> using cross-validation and test datasets from various regions.</li>
<li>Incorporate <strong>time-based validation</strong> to ensure the model is robust against temporal variations.</li>
<li>Use <strong>feature importance analysis</strong> to identify key drivers of rental prices and improve model interpretability.</li>
</ul>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">8. Conclusion</h2>
<p>This project aims to leverage <strong>postal code-based geolocation</strong>, <strong>spatial analysis</strong>, and <strong>machine learning</strong> to provide actionable insights into how business trends influence rental markets. The combination of robust data analysis and interactive tools will support decision-making in various domains, including:</p>
<ul>
<li><strong>Urban Planning</strong>: Providing insights into accessibility and infrastructure impact on rental prices.</li>
<li><strong>Real Estate Decision-Making</strong>: Helping landlords and tenants understand rental trends and property valuation.</li>
<li><strong>Policy Formulation</strong>: Offering data-driven recommendations for government agencies to address housing affordability and business development.</li>
</ul>
<p>The key outputs of the project include:</p>
<ul>
<li><strong>Spatial Analysis Outputs</strong>: Hotspot maps and accessibility layers.</li>
<li><strong>Predictive Model</strong>: A machine learning model to forecast rental prices.</li>
<li><strong>Interactive Dashboard</strong>: An R Shiny application for exploring trends and predictions.</li>
<li><strong>Comprehensive Report</strong>: An R Quarto document detailing the analysis process, insights, and recommendations.</li>
</ul>
<p>By addressing the challenges associated with geocoding, handling large datasets, and ensuring model generalization, this project will provide a valuable contribution to the fields of urban planning, real estate, and data-driven policymaking.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>